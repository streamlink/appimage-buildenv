name: Build and deploy
on:
  push: {}

jobs:
  build:
    name: Build
    permissions:
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: aarch64
            runs-on: ubuntu-24.04-arm
            BASEIMAGE: "quay.io/pypa/manylinux_2_28_aarch64@sha256:d9c1b6e58f1e5ec3b603a36aa61c44a972010709248c7c5bc1a3477af34a0e0d"
            PYTHON_VERSION: "3.13"
          - arch: x86_64
            runs-on: ubuntu-24.04
            BASEIMAGE: "quay.io/pypa/manylinux_2_28_x86_64@sha256:ecc0629e3ced461c6a7999a292834a546ae489119696be7beaceccbde99abdd9"
            PYTHON_VERSION: "3.13"
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config: .github/buildkit.toml
      - name: build image
        run: |
          docker build \
            --tag "${GITHUB_REPOSITORY}-${{ matrix.arch }}:${GITHUB_SHA}" \
            --build-arg "BASEIMAGE=${{ matrix.BASEIMAGE }}" \
            --build-arg "PYTHON_VERSION=${{ matrix.PYTHON_VERSION }}" \
            .
      - name: push image
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin
          docker tag \
            "${GITHUB_REPOSITORY}-${{ matrix.arch }}:${GITHUB_SHA}" \
            "ghcr.io/${GITHUB_REPOSITORY}-${{ matrix.arch }}:${GITHUB_REF/#refs\/tags\//}"
          docker push "ghcr.io/${GITHUB_REPOSITORY}-${{ matrix.arch }}:${GITHUB_REF/#refs\/tags\//}"
